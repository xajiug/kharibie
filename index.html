<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Escape Maze ‚Äî –ü–æ–±–µ–≥ –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞</title>
  <meta name="theme-color" content="#111827">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --line:#1f2a44; --text:#e5e7eb; --muted:#94a3b8;
      --accent:#22d3ee; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --r:16px; --shadow:0 8px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:radial-gradient(1000px 500px at 50% -10%, #111827 0%, #0b1220 50%, #080d18 100%);color:var(--text);-webkit-tap-highlight-color:transparent}
    .wrap{max-width:900px;margin:0 auto;padding:12px}
    header{position:sticky;top:0;z-index:5;padding:8px 0;background:linear-gradient(180deg, rgba(8,13,24,.9), rgba(8,13,24,.5) 60%, rgba(8,13,24,0));backdrop-filter: blur(6px)}
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:-.02em;font-size:22px;margin:0}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#0a1220;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
    .card{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .content{padding:12px}
    .grid{display:grid;gap:12px}
    @media (min-width: 900px){ .grid{grid-template-columns:1fr .9fr} .title{font-size:28px} .wrap{padding:20px} .content{padding:20px} }
    .canvasWrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--line)}
    canvas{display:block;width:100%;height:auto;background:#0a0f1b}
    .hud{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px}
    .hud .group{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .stat{background:#0b1422;border:1px solid #132033;border-radius:12px;padding:8px 10px;font-size:13px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn.primary{background:var(--accent);color:#001018}
    .btn.gray{background:#1f2937;color:#e5e7eb}
    .btn.green{background:var(--accent2);color:#02120a}
    .btn.warn{background:var(--warn);}
    .controls{display:grid;grid-template-columns:repeat(3,64px);gap:8px;justify-content:center;margin-top:10px}
    .ctrl{width:64px;height:64px;border-radius:14px;background:#0b1422;border:1px solid #132033;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:900;cursor:pointer;user-select:none}
    .ctrl:active{transform:scale(.98)}
    .note{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.7);z-index:50}
    .dialog{background:linear-gradient(180deg,#0f172a,#0b1220);border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);padding:18px;max-width:420px;width:92%}
    .dialog h2{margin:0 0 6px 0}
    .dialog p{margin:8px 0;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="title">Escape Maze ‚Äî –ü–æ–±–µ–≥ –∏–∑ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞</div>
          <div class="muted" id="userInfo">–ù–∞–π–¥–∏ –≤—ã—Ö–æ–¥ –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏.</div>
        </div>
        <div class="row">
          <span class="pill" id="saveState">üíæ auto</span>
          <button id="newMaze" class="btn gray">–ù–æ–≤—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç</button>
        </div>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <div class="content">
          <div class="canvasWrap">
            <canvas id="mazeCanvas" width="720" height="540"></canvas>
          </div>

          <div class="hud">
            <div class="group">
              <div class="stat">‚è±Ô∏è –í—Ä–µ–º—è: <b id="time">0.00</b>s</div>
              <div class="stat">üèÅ –õ—É—á—à–µ–µ: <b id="best">‚Äî</b>s</div>
              <div class="stat">üìè –†–∞–∑–º–µ—Ä: <b id="sizeLbl">15√ó11</b></div>
            </div>
            <div class="group">
              <button id="smaller" class="btn gray">‚àí</button>
              <button id="bigger" class="btn gray">+</button>
              <button id="restart" class="btn primary">–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫</button>
            </div>
          </div>

          <div class="controls" id="ctrls">
            <div class="ctrl"></div>
            <div class="ctrl" data-dir="up">‚¨ÜÔ∏è</div>
            <div class="ctrl"></div>
            <div class="ctrl" data-dir="left">‚¨ÖÔ∏è</div>
            <div class="ctrl" data-dir="down">‚¨áÔ∏è</div>
            <div class="ctrl" data-dir="right">‚û°Ô∏è</div>
          </div>
          <div class="note">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–≤–∞–π–ø–∞–º–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞–º–∏ ‚Üë ‚Üì ‚Üê ‚Üí</div>
        </div>
      </div>

      <div class="card">
        <div class="content">
          <h3 style="margin:0 0 6px 0">–ü—Ä–∞–≤–∏–ª–∞</h3>
          <ul style="margin:6px 0 0 18px;color:var(--muted);font-size:14px;line-height:1.5">
            <li>–¢–≤–æ–π –º–∞—Ä–∫–µ—Ä ‚Äî <b style="color:#22d3ee">–≥–æ–ª—É–±–æ–π –∫–≤–∞–¥—Ä–∞—Ç</b>. –í—ã—Ö–æ–¥ ‚Äî <b style="color:#22c55e">–∑–µ–ª—ë–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç</b>.</li>
            <li>–î–æ–π–¥–∏ –¥–æ –≤—ã—Ö–æ–¥–∞ –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–µ–µ. –í—Ä–µ–º—è –∏–¥—ë—Ç.</li>
            <li>–ö–∞–∂–¥—ã–π —Ä–∞–∑ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π –ª–∞–±–∏—Ä–∏–Ω—Ç.</li>
            <li>–°–≤–∞–π–ø–∞–π –ø–æ –ø–æ–ª—é –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏. –ù–∞ –ü–ö ‚Äî –∫–ª–∞–≤–∏—à–∏ —Å—Ç—Ä–µ–ª–æ–∫.</li>
            <li>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</li>
          </ul>

          <div style="margin-top:12px" class="row">
            <button id="how" class="btn gray">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</button>
            <button id="share" class="btn green">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∫–æ—Ä–¥–æ–º</button>
          </div>
          <p class="muted" style="margin-top:6px">–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ Telegram Mini App –∏ –∫–∞–∫ –æ–±—ã—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="dialog">
      <h2>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</h2>
      <p>–õ–∞–±–∏—Ä–∏–Ω—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º <b>DFS backtracker</b>: —É–¥–∞–ª—è—é—Ç—Å—è —Å—Ç–µ–Ω—ã –º–µ–∂–¥—É —Å–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å–æ—Å–µ–¥—è–º–∏, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ—Å–µ—â–µ–Ω–∞ –≤—Å—è —Å–µ—Ç–∫–∞. –ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ ‚Äî –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å.</p>
      <p>–ü–æ–¥ –∫–∞–ø–æ—Ç–æ–º: –∫–∞–Ω–≤–∞—Å –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–µ–ª–∫–∞–º–∏, –∫–Ω–æ–ø–∫–∏ –∏ —Å–≤–∞–π–ø—ã –Ω–∞ —Ç–∞—á‚Äë—ç–∫—Ä–∞–Ω–∞—Ö. –õ—É—á—à–µ–µ –≤—Ä–µ–º—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ <b>localStorage</b>.</p>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="closeModal" class="btn primary">–ü–æ–Ω—è—Ç–Ω–æ</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      try {
        const tg = window.Telegram && window.Telegram.WebApp;
        if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
          const u = tg.initDataUnsafe.user;
          document.getElementById('userInfo').textContent = `–ò–≥—Ä–æ–∫: ${u.first_name || '–ì–æ—Å—Ç—å'} ${u.last_name || ''}`.trim();
          tg.expand();
          const meta = document.querySelector('meta[name=\"theme-color\"]');
          meta && meta.setAttribute('content', (tg.themeParams && tg.themeParams.bg_color) || '#111827');
        }
      } catch(e) {}
    })();

    const SKEY = 'escape_maze_best_v1';

    function genMaze(w,h){
      const grid = Array.from({length:h}, (_,y)=>Array.from({length:w}, (_,x)=>({
        x, y, v:false, walls:[true,true,true,true]
      })));
      const stack = [];
      const dirs = [[0,-1,0,2],[1,0,1,3],[0,1,2,0],[-1,0,3,1]];
      let cx = 0, cy = 0;
      grid[cy][cx].v = true;
      stack.push(grid[cy][cx]);
      while (stack.length){
        const cur = stack[stack.length-1];
        const {x,y} = cur;
        const neigh = [];
        for (const [dx,dy,cw,nw] of dirs){
          const nx=x+dx, ny=y+dy;
          if (nx>=0 && ny>=0 && nx<w && ny<h && !grid[ny][nx].v) neigh.push([nx,ny,cw,nw]);
        }
        if (neigh.length === 0){ stack.pop(); continue; }
        const [nx,ny,cw,nw] = neigh[Math.floor(Math.random()*neigh.length)];
        const ncell = grid[ny][nx];
        cur.walls[cw] = false;
        ncell.walls[nw] = false;
        ncell.v = true;
        stack.push(ncell);
      }
      return grid;
    }

    const canvas = document.getElementById('mazeCanvas');
    const ctx = canvas.getContext('2d');
    const timeEl = document.getElementById('time');
    const bestEl = document.getElementById('best');
    const sizeLbl = document.getElementById('sizeLbl');

    let W = 15, H = 11;
    let grid = null;
    let cellSize = 32;
    let px = 0, py = 0;
    let ex = 0, ey = 0;
    let running = false;
    let startTime = 0;
    let best = null;

    function loadBest(){
      try{ const raw = localStorage.getItem(SKEY); if (raw) best = parseFloat(raw); }catch(e){}
      bestEl.textContent = best ? best.toFixed(2) : '‚Äî';
    }
    function saveBest(t){
      try{ localStorage.setItem(SKEY, String(t)); }catch(e){}
    }

    function fitCanvas(){
      const wrapWidth = canvas.parentElement.clientWidth;
      cellSize = Math.floor(Math.max(20, Math.min(48, wrapWidth / W)));
      canvas.width = cellSize * W;
      canvas.height = cellSize * H;
    }

    function newMaze(){
      grid = genMaze(W,H);
      px = 0; py = 0;
      ex = W-1; ey = H-1;
      startTime = performance.now();
      running = true;
      sizeLbl.textContent = `${W}√ó${H}`;
      fitCanvas();
      draw();
    }

    function draw(){
      ctx.fillStyle = '#0a0f1b';
      ctx.fillRect(0,0,canvas.width,canvas.height);

      ctx.strokeStyle = '#22304c';
      ctx.lineWidth = 2;
      for (let y=0;y<H;y++){
        for (let x=0;x<W;x++){
          const c = grid[y][x];
          const sx = x*cellSize, sy = y*cellSize;
          ctx.beginPath();
          if (c.walls[0]){ ctx.moveTo(sx,sy); ctx.lineTo(sx+cellSize,sy); }
          if (c.walls[1]){ ctx.moveTo(sx+cellSize,sy); ctx.lineTo(sx+cellSize,sy+cellSize); }
          if (c.walls[2]){ ctx.moveTo(sx,sy+cellSize); ctx.lineTo(sx+cellSize,sy+cellSize); }
          if (c.walls[3]){ ctx.moveTo(sx,sy); ctx.lineTo(sx,sy+cellSize); }
          ctx.stroke();
        }
      }

      ctx.fillStyle = '#22c55e';
      ctx.fillRect(ex*cellSize+6, ey*cellSize+6, cellSize-12, cellSize-12);

      ctx.fillStyle = '#22d3ee';
      ctx.fillRect(px*cellSize+6, py*cellSize+6, cellSize-12, cellSize-12);
    }

    function canMove(nx,ny){
      if (nx<0 || ny<0 || nx>=W || ny>=H) return false;
      const cur = grid[py][px];
      const dir = [nx-px, ny-py];
      if (dir[0]===0 && dir[1]===-1) return !cur.walls[0];
      if (dir[0]===1 && dir[1]===0) return !cur.walls[1];
      if (dir[0]===0 && dir[1]===1) return !cur.walls[2];
      if (dir[0]===-1 && dir[1]===0) return !cur.walls[3];
      return false;
    }

    function move(dx,dy){
      if (!running) return;
      const nx = px + dx, ny = py + dy;
      if (!canMove(nx,ny)) return;
      px = nx; py = ny;
      if (px===ex && py===ey){
        running = false;
        const t = (performance.now() - startTime)/1000;
        timeEl.textContent = t.toFixed(2);
        if (!best || t < best){ best = t; bestEl.textContent = best.toFixed(2); saveBest(best); }
        showWin(t);
      }
      draw();
    }

    function loop(){
      if (running){
        const t = (performance.now() - startTime)/1000;
        timeEl.textContent = t.toFixed(2);
      }
      requestAnimationFrame(loop);
    }

    document.getElementById('restart').addEventListener('click', ()=>{ px=0;py=0; startTime=performance.now(); running=true; draw(); });
    document.getElementById('newMaze').addEventListener('click', ()=> newMaze());
    document.getElementById('smaller').addEventListener('click', ()=>{ W=Math.max(7, W-2); H=Math.max(5, H-2); newMaze(); });
    document.getElementById('bigger').addEventListener('click', ()=>{ W=Math.min(35, W+2); H=Math.min(25, H+2); newMaze(); });

    document.getElementById('ctrls').addEventListener('click', (e)=>{
      const dir = e.target.getAttribute('data-dir');
      if (!dir) return;
      if (dir==='up') move(0,-1);
      if (dir==='down') move(0,1);
      if (dir==='left') move(-1,0);
      if (dir==='right') move(1,0);
    });

    window.addEventListener('keydown', (e)=>{
      const k = e.key;
      if (k==='ArrowUp') move(0,-1);
      else if (k==='ArrowDown') move(0,1);
      else if (k==='ArrowLeft') move(-1,0);
      else if (k==='ArrowRight') move(1,0);
    });

    (function(){
      let sx=0, sy=0, dx=0, dy=0, touching=false;
      const area = canvas;
      area.addEventListener('touchstart', (e)=>{
        const t = e.changedTouches[0];
        sx = t.clientX; sy = t.clientY; touching=true;
      }, {passive:true});
      area.addEventListener('touchmove', (e)=>{
        if (!touching) return;
        const t = e.changedTouches[0];
        dx = t.clientX - sx; dy = t.clientY - sy;
      }, {passive:true});
      area.addEventListener('touchend', ()=>{
        if (!touching) return;
        touching=false;
        const ax = Math.abs(dx), ay = Math.abs(dy);
        if (Math.max(ax,ay) < 20) return;
        if (ax > ay){ if (dx>0) move(1,0); else move(-1,0); }
        else { if (dy>0) move(0,1); else move(0,-1); }
        dx=dy=0;
      }, {passive:true});
    })();

    const modal = document.getElementById('modal');
    document.getElementById('how').addEventListener('click', ()=>{ modal.style.display='flex'; });
    document.getElementById('closeModal').addEventListener('click', ()=>{ modal.style.display='none'; });

    function showWin(t){
      modal.style.display='flex';
      modal.querySelector('.dialog h2').textContent = '–ü–æ–±–µ–¥–∞!';
      modal.querySelector('.dialog p').innerHTML = '–¢–≤–æ—ë –≤—Ä–µ–º—è: <b>'+t.toFixed(2)+'s</b>. –ü–æ–ø—Ä–æ–±—É–π —É–ª—É—á—à–∏—Ç—å —Ä–µ–∫–æ—Ä–¥!';
    }

    window.addEventListener('resize', ()=>{ fitCanvas(); draw(); });
    loadBest();
    newMaze();
    loop();
  </script>
</body>
</html>
